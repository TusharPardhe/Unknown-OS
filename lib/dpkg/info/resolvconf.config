#!/bin/sh

set -e

. /usr/share/debconf/confmodule

eni_seems_adequate()
{
	# Assume that if _any_ dns-nameserver[s] line appears in
	# the interfaces file then that is adequate.
	# Formerly: [ -f /etc/network/interfaces ] && grep -q dns-nameservers /etc/network/interfaces > /dev/null
	# but now we use ifquery for correctness.
	ifquery $(ifquery --list -a) | grep -q '^dns-nameserver'
}

original_seems_nm_generated()
{
	# /etc/resolv.conf is a file, not a symlink (and thus
	# soon to be moved to resolv.conf.d/original) and seems
	# to have been generated by NetworkManager.
	[ -s /etc/resolv.conf ] \
	&& ! [ -L /etc/resolv.conf ] \
	&& grep -q '# Generated by NetworkManager' /etc/resolv.conf >/dev/null 2>&1
}

db_input low resolvconf/linkify-resolvconf || :
db_go
db_get resolvconf/linkify-resolvconf
if \
	[ "$RET" = "true" ] \
	&& ! [ -e /var/lib/resolvconf/linkified ] \
	&& ! [ -e /etc/resolvconf/resolv.conf.d/tail ] \
	&& ! [ -L /etc/resolvconf/resolv.conf.d/tail ]
then
	if eni_seems_adequate || original_seems_nm_generated ; then
		db_input low resolvconf/link-tail-to-original || :
	else
		db_input medium resolvconf/link-tail-to-original || :
	fi
fi

db_input medium resolvconf/downup-interfaces || :
db_go

db_stop

